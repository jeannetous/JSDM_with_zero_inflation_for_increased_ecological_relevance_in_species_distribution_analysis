---
title: "Species association networks unveil scale effects in community assemblage mechanisms."
author: "Jeanne Tous, Julien Chiquet"
format: html
editor: visual
---

## Useful libraries & functions

PLNmodels version should be 1.2.1 or higher.

```{r, loading libraries}
library(dplyr)
# library(PLNmodels)
library(igraph)
```

```{r, function to plot networks}
plot_network = function(net             ,
                        type            ,
                        edge.color      = c("#F8766D", "#00BFC4"),
                        remove.isolated = FALSE,
                        node.labels     = NULL,
                        layout          = layout_in_circle) {
  G <-  graph_from_adjacency_matrix(net, mode = "undirected", weighted = TRUE, diag = FALSE)

  if (!is.null(node.labels)) {
    igraph::V(G)$label <- node.labels
  } else {
    igraph::V(G)$label <- colnames(net)
  }
  ## Nice nodes
  V.deg <- degree(G)/sum(degree(G))
  igraph::V(G)$label.cex <- V.deg / max(V.deg) + .5
  igraph::V(G)$size <- V.deg * 100
  igraph::V(G)$label.color <- rgb(0, 0, .2, .8)
  igraph::V(G)$frame.color <- NA
  ## Nice edges
  igraph::E(G)$color <- ifelse(igraph::E(G)$weight > 0, edge.color[1], edge.color[2])
  if (type == "support")
    igraph::E(G)$width <- abs(igraph::E(G)$weight)
  else
    igraph::E(G)$width <- 15*abs(igraph::E(G)$weight)

  if (remove.isolated) {
    G <- delete.vertices(G, which(degree(G) == 0))
  }
  plot(G, layout = layout, font.size = 8)
  invisible(G)
}

```

## Loading & formatting data

### Regional dataset

```{r, loading regional dataset}
load("REGIONAL_DATASET_COUNTS.Rdata")
load("REGIONAL_DATASET_COVARIATES.Rdata")
```

```{r, formatting regional data for PLNmodels}
regional_data <- prepare_data(counts     = REGIONAL_DATASET_COUNTS,
                              covariates = REGIONAL_DATASET_COVARIATES)
```

### Northern Range dataset

```{r, loading Northern Range dataset}
load("NORTHERN_RANGE_DATASET_COUNTS.Rdata")
load("NORTHERN_RANGE_DATASET_COVARIATES.Rdata")
```

```{r, formatting Northern Range data for PLNmodels}
northern_range_data <- prepare_data(counts     = NORTHERN_RANGE_DATASET_COUNTS,
                                    covariates = NORTHERN_RANGE_DATASET_COVARIATES)
```

## Running the ZIPLN-network model

We fix the seed for reproducibility.

```{r, fixing the seed}
set.seed(1)
```

### Regional dataset

```{r, running ZIPLNnetwork on the regional data}
regional_model <- ZIPLNnetwork(Abundance ~ 1 + LONGLAT, data = regional_data, control = ZIPLNnetwork_param(min_ratio = 0.001,  penalize_diagonal = FALSE), zi = "col")

```

We select a penalty using stability selection process StARS. As it stability selection requires a long time to run, we memorize the corresponding penalty and later use it directly to access the model selected with StARS.

```{r, fixing regularization penalty with StARS - regional}
# regional_model_StARS <- regional_model$getBestModel("StARS")
regional_model_StARS <- regional_model$getModel(0.06950515) 
```

### Northern Range dataset

```{r, running ZIPLNnetwork on the Northern Range data}
northern_range_model <- ZIPLNnetwork(Abundance ~ 1 + LONGLAT, data = northern_range_data, control = ZIPLNnetwork_param(min_ratio = 0.001,  penalize_diagonal = FALSE), zi = "col")

```

We select a penalty using stability selection process StARS. As it stability selection requires a long time to run, we memorize the corresponding penalty and later use it directly to access the model selected with StARS.

```{r, fixing regularization penalty with StARS - Northern Range}

# northern_range_model_StARS <- northern_range_model$getBestModel("StARS")
northern_range_model_StARS <- northern_range_model$getModel(0.08646393)
```

## Resulting networks

We want to place species the datasets share in the same order for readibility.

```{r, retrieving the lists of species to sort them}
regional_species       <- colnames(regional_data$Abundance)
northern_range_species <- colnames(northern_range_data$Abundance)
intersecting_species   <- intersect(northern_range_species, regional_species)
```

### Regional network

Sorting species names.

```{r, sorting regional species}
regional_sorted_species <- c(intersecting_species, regional_species[! regional_species %in% intersecting_species])
```

Extracting the association network from the model.

```{r, sorting regional network}
regional_network        <- as.matrix(regional_model_StARS$latent_network("partial_cor"))
regional_sorted_indices <- match(regional_sorted_species, colnames(regional_network))
regional_network        <- regional_network[regional_sorted_indices, regional_sorted_indices] 
```

```{r, plotting regional network}
plot_network(regional_network,
             type            = "partial_cor",
             edge.color      = c("#F8766D", "#00BFC4"),
             remove.isolated = FALSE,
             node.labels     = NULL,
             layout          = layout_in_circle)
```

### Northern Range network

Sorting species names.

```{r,  sorting Northern Range species}
northern_range_sorted_species <- c(intersecting_species, northern_range_species[! northern_range_species %in% intersecting_species])
```

```{r, sorting Northern Range network}
northern_range_network        <- as.matrix(northern_range_model_StARS$latent_network("partial_cor"))
northern_range_sorted_indices <- match(northern_range_sorted_species, colnames(northern_range_network))
northern_range_network        <- northern_range_network[northern_range_sorted_indices, northern_range_sorted_indices] 
```

```{r, plotting Northern Range network}
plot_network(northern_range_network,
             type            = "partial_cor",
             edge.color      = c("#F8766D", "#00BFC4"),
             remove.isolated = FALSE,
             node.labels     = NULL,
             layout          = layout_in_circle)
```
